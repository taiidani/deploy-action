# Vault Integration

This repository uses HashiCorp Vault for secrets management in Docker Compose deployments.

## Overview

All services with sensitive configuration use Vault Agent to render `.env` files from Vault secrets. This keeps secrets out of the repository while making them available to Docker Compose at runtime.

## Local Usage

### Rendering Secrets

1. Ensure you're authenticated to Vault (token in `~/.vault-token`)
2. Run the Mise task to render all service secrets:
   ```bash
   mise run render-secrets
   ```
3. Start your services:
   ```bash
   cd <service-name>
   docker compose up -d
   ```

**Example:**
```bash
mise run render-secrets
cd groceries
docker compose up -d
```

### How It Works

**Configuration Files:**
- `vault_config.hcl` - Vault Agent configuration defining all service templates
- `<service>/secrets.env.tmpl` - Per-service template that fetches secrets from Vault
- `<service>/.env` - Rendered output (gitignored, generated by Vault Agent)

**Workflow:**
When you run `mise run render-secrets`, Vault Agent:
1. Authenticates using your local `~/.vault-token`
2. Fetches secrets from Vault at `deploy/<service-name>`
3. Renders all `.env` files from their templates
4. Exits (run-once mode with `-exit-after-auth`)

**Docker Compose Integration:**
Services reference environment variables that are loaded from the rendered `.env` files:
```yaml
services:
  app:
    environment:
      DATABASE_URL: "${DATABASE_URL}"
      API_KEY: "${API_KEY}"
```

## Adding Secrets for a New Service

1. **Store secrets in Vault** at `deploy/<service-name>`
2. **Create a template file** at `<service>/secrets.env.tmpl`:
   ```
   DATABASE_URL="{{with secret "deploy/service-name"}}{{ .Data.data.DATABASE_URL }}{{end}}"
   API_KEY="{{with secret "deploy/service-name"}}{{ .Data.data.API_KEY }}{{end}}"
   ```
3. **Register in `vault_config.hcl`**:
   ```hcl
   template {
     source      = "<service>/secrets.env.tmpl"
     destination = "<service>/.env"
   }
   ```
4. **Render and test**:
   ```bash
   mise run render-secrets
   cd <service>
   docker compose up -d
   ```

## Vault Configuration

- **URL:** `https://rnd.vault.0846e66f-a975-4a88-9e46-6dc6267e9b73.aws.hashicorp.cloud:8200`
- **Namespace:** `admin`
- **Authentication:** Token file at `/home/rnixon/.vault-token` (local development)
- **Secret Paths:**
  - `deploy/<service-name>` - Service-specific secrets
  - `credentials/data/digitalocean/spaces` - S3 credentials (for binary publishing workflow)

## Services with Vault Integration

Current services using Vault secrets:
- `gitea/` - Git service credentials
- `groceries/` - Database and API credentials
- `lil-dumpster/` - Discord bot tokens
- `no-time-to-explain/` - Discord bot and Bungie API credentials
- `servarr/` - Media management credentials
- `tfc-agent/` - Terraform Cloud tokens

## Legacy: Nomad Integration

Previously, Nomad jobs used built-in Vault integration with the `template` stanza. These configurations are archived in `archive/jobs/` for reference.
