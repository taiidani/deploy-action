# Vault Integration

This repository uses HashiCorp Vault for secrets management across both Docker Compose and Nomad deployments.

## Docker Compose Services

Docker Compose services use Vault Agent in "run once" mode to render `.env` files from Vault secrets.

### Local Usage

1. Ensure `VAULT_ADDR` is set and you're authenticated to Vault (token in `~/.vault-token`)
2. Run the Mise task to render all service secrets:
   ```bash
   mise run render-secrets
   ```
3. Start a service:
   ```bash
   cd <service-name>
   docker-compose up -d
   ```

**Example:**
```bash
mise run render-secrets
cd lil-dumpster
docker-compose up -d
```

### How It Works

The repository contains:
- `vault_config.hcl` - Vault Agent configuration defining all service templates
- `<service>/secrets.env.tmpl` - Per-service template that fetches secrets from Vault
- `<service>/.env` - Rendered output (gitignored, generated by Vault Agent)

When you run `mise run render-secrets`, Vault Agent:
1. Authenticates using your local `~/.vault-token`
2. Fetches secrets from Vault for each service
3. Renders all `.env` files from their templates
4. Exits

### GitHub Actions (Future)

For CI/CD, Vault Agent will use JWT authentication instead of token files. The `vault_config.hcl` will need to support both auth methods.

## Nomad Jobs

Nomad jobs use the built-in Vault integration with the `template` stanza to fetch secrets at runtime. See `jobs/*.nomad` for examples.
